<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è¯æ±‡å­¦ä¹ ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .word-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }

        .word-title {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .word-translation {
            font-size: 16px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .word-tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 2px;
            font-size: 14px;
        }
        
        .word-preview {
            margin: 10px 0;
        }

        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
        }

        .option {
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .option:hover {
            border-color: #667eea;
            background: #e3f2fd;
        }

        .option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .option.correct {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .option.wrong {
            background: #f44336;
            color: white;
            border-color: #f44336;
        }

        .level-result {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            margin: 20px 0;
        }

        .level-badge {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .study-plan {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        .plan-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }

        .review-schedule {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .review-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .review-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .review-item.due {
            border-color: #ff9800;
            background: #fff3e0;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .options {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ æ™ºèƒ½è¯æ±‡å­¦ä¹ ç³»ç»Ÿ</h1>
            <p>ç§‘å­¦è¯„ä¼°è¯æ±‡é‡ï¼Œåˆ¶å®šä¸ªæ€§åŒ–å­¦ä¹ è®¡åˆ’ï¼Œéµå¾ªé—å¿˜æ›²çº¿ä¼˜åŒ–å¤ä¹ </p>
        </div>

        <div class="card">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('test')">ğŸ“Š è¯æ±‡é‡æµ‹è¯•</button>
                <button class="nav-tab" onclick="switchTab('study')">ğŸ“š å­¦ä¹ è®¡åˆ’</button>
                <button class="nav-tab" onclick="switchTab('review')">ğŸ”„ å¤ä¹ ç®¡ç†</button>
                <button class="nav-tab" onclick="switchTab('stats')">ğŸ“ˆ å­¦ä¹ ç»Ÿè®¡</button>
            </div>

            <!-- è¯æ±‡é‡æµ‹è¯• -->
            <div id="test" class="tab-content active">
                <h2>ğŸ“Š è¯æ±‡é‡æ°´å¹³æµ‹è¯•</h2>
                <p>é€šè¿‡ç§‘å­¦çš„æµ‹è¯•æ–¹æ³•ï¼Œå‡†ç¡®è¯„ä¼°æ‚¨çš„è¯æ±‡é‡æ°´å¹³</p>
                
                <div id="test-start" class="text-center">
                    <div class="progress-bar">
                        <div class="progress-fill" id="test-progress" style="width: 0%"></div>
                    </div>
                    <p>æµ‹è¯•å°†ä»å„ä¸ªçº§åˆ«éšæœºé€‰æ‹©å•è¯ï¼Œæ ¹æ®æ‚¨çš„ç­”é¢˜æƒ…å†µæ™ºèƒ½è°ƒæ•´éš¾åº¦</p>
                    <button class="btn" onclick="startTest()">å¼€å§‹æµ‹è¯•</button>
                </div>

                <div id="test-question" class="hidden">
                    <div class="word-card">
                        <div class="word-title" id="current-word" style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                            <span id="test-word-text"></span>
                            <button class="btn" onclick="speakTestWord()" style="padding: 8px 15px; font-size: 14px; background: #2196F3;">ğŸ”Š å‘éŸ³</button>
                        </div>
                        <div class="word-translation">è¯·é€‰æ‹©æ­£ç¡®çš„ä¸­æ–‡é‡Šä¹‰ï¼š</div>
                        <div class="options" id="options-container"></div>
                        <div class="text-center">
                            <button class="btn" id="next-btn" onclick="nextQuestion()" disabled>ä¸‹ä¸€é¢˜</button>
                            <button class="btn" onclick="skipQuestion()">è·³è¿‡</button>
                        </div>
                    </div>
                    <div class="text-center">
                        <p>é¢˜ç›® <span id="question-num">1</span> / <span id="total-questions">20</span></p>
                    </div>
                </div>

                <div id="test-result" class="hidden">
                    <div class="level-result">
                        <div class="level-badge" id="result-level"></div>
                        <h3 id="result-title"></h3>
                        <p id="result-description"></p>
                        <div class="stats">
                            <div class="stat-item">
                                <div class="stat-number" id="correct-count">0</div>
                                <div class="stat-label">ç­”å¯¹é¢˜æ•°</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="accuracy-rate">0%</div>
                                <div class="stat-label">æ­£ç¡®ç‡</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="estimated-vocab">0</div>
                                <div class="stat-label">ä¼°è®¡è¯æ±‡é‡</div>
                            </div>
                        </div>
                        <button class="btn" onclick="generateStudyPlan()">ç”Ÿæˆå­¦ä¹ è®¡åˆ’</button>
                        <button class="btn" onclick="restartTest()">é‡æ–°æµ‹è¯•</button>
                    </div>
                </div>
            </div>

            <!-- å­¦ä¹ è®¡åˆ’ -->
            <div id="study" class="tab-content">
                <h2>ğŸ“š ä¸ªæ€§åŒ–å­¦ä¹ è®¡åˆ’</h2>
                <div id="no-plan">
                    <p>è¯·å…ˆå®Œæˆè¯æ±‡é‡æµ‹è¯•ï¼Œç³»ç»Ÿå°†ä¸ºæ‚¨ç”Ÿæˆä¸ªæ€§åŒ–çš„å­¦ä¹ è®¡åˆ’ã€‚</p>
                    <button class="btn" onclick="switchTab('test')">å»æµ‹è¯•</button>
                </div>
                
                <div id="study-plan-content" class="hidden">
                    <div class="study-plan">
                        <h3>ğŸ¯ å½“å‰å­¦ä¹ ç›®æ ‡</h3>
                        <div id="current-goal"></div>
                    </div>
                    
                    <div class="study-plan">
                        <h3>ğŸ“‹ å­¦ä¹ è®¡åˆ’</h3>
                        <div id="plan-list"></div>
                    </div>
                    
                    <div class="study-plan">
                        <h3>ğŸ“– ä»Šæ—¥å­¦ä¹ </h3>
                        <div id="daily-words"></div>
                        <button class="btn" onclick="startDailyStudy()">å¼€å§‹ä»Šæ—¥å­¦ä¹ </button>
                    </div>
                </div>
                
                <!-- å­¦ä¹ ç•Œé¢ -->
                <div id="study-session" class="hidden">
                    <div class="word-card">
                        <div class="text-center">
                            <h3 id="study-level-title">æ­£åœ¨å­¦ä¹ ï¼šåˆä¸­çº§åˆ«</h3>
                            <div class="progress-bar">
                                <div class="progress-fill" id="study-progress" style="width: 0%"></div>
                            </div>
                            <p>å•è¯ <span id="study-word-num">1</span> / <span id="study-total-words">20</span></p>
                        </div>
                        
                        <div class="word-title" id="study-current-word" style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                            <span id="study-word-text">abandon</span>
                            <button class="btn" onclick="speakWord()" style="padding: 8px 15px; font-size: 14px; background: #2196F3;">ğŸ”Š å‘éŸ³</button>
                        </div>
                        <div class="word-translation" id="study-word-translation">v. æ”¾å¼ƒï¼ŒæŠ›å¼ƒ</div>
                        
                        <!-- ä¾‹å¥æ˜¾ç¤º -->
                        <div id="study-word-phrases" class="word-translation" style="margin-top: 15px; font-style: italic;"></div>
                        
                        <div class="text-center" style="margin-top: 30px;">
                            <button class="btn" onclick="markWordKnown(true)" style="background: #4caf50;">âœ“ è®¤è¯†</button>
                            <button class="btn" onclick="markWordKnown(false)" style="background: #f44336;">âœ— ä¸è®¤è¯†</button>
                            <button class="btn" onclick="skipStudyWord()">è·³è¿‡</button>
                        </div>
                    </div>
                </div>
                
                <!-- å­¦ä¹ å®Œæˆç»“æœ -->
                <div id="study-result" class="hidden">
                    <div class="level-result">
                        <div class="level-badge">ğŸ‰</div>
                        <h3 id="study-result-title">å­¦ä¹ å®Œæˆï¼</h3>
                        <p id="study-result-description">æ­å–œæ‚¨å®Œæˆäº†æœ¬æ¬¡å­¦ä¹ ä»»åŠ¡</p>
                        <div class="stats">
                            <div class="stat-item">
                                <div class="stat-number" id="study-known-count">0</div>
                                <div class="stat-label">è®¤è¯†çš„è¯</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="study-unknown-count">0</div>
                                <div class="stat-label">ä¸è®¤è¯†çš„è¯</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="study-mastery-rate">0%</div>
                                <div class="stat-label">æŒæ¡ç‡</div>
                            </div>
                        </div>
                        <button class="btn" onclick="finishStudySession()">å®Œæˆå­¦ä¹ </button>
                        <button class="btn" onclick="reviewUnknownWords()">å¤ä¹ ä¸è®¤è¯†çš„è¯</button>
                        <button class="btn" onclick="startMasteryTest()" style="background: #FF9800;">ğŸ¯ æŒæ¡åº¦æµ‹è¯•</button>
                    </div>
                </div>
                
                <!-- æŒæ¡åº¦æµ‹è¯•ç•Œé¢ -->
                <div id="mastery-test" class="hidden">
                    <div class="level-result">
                        <div class="level-badge">ğŸ§ </div>
                        <h3 id="test-title">æŒæ¡åº¦æµ‹è¯•</h3>
                        <p id="test-description">è¯·é€‰æ‹©æ­£ç¡®çš„ä¸­æ–‡ç¿»è¯‘</p>
                        
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div id="test-progress" class="progress-fill"></div>
                            </div>
                            <p>é¢˜ç›® <span id="test-question-num">1</span> / <span id="test-total-questions">10</span></p>
                        </div>
                        
                        <div class="test-question">
                            <div class="word-title" id="test-word" style="font-size: 2.5em; margin: 30px 0;">abandon</div>
                            
                            <div class="test-options" id="test-options">
                                <!-- é€‰é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                        
                        <div id="test-feedback" class="hidden" style="margin: 20px 0;">
                            <p id="feedback-text"></p>
                            <button class="btn" onclick="nextTestQuestion()">ä¸‹ä¸€é¢˜</button>
                        </div>
                    </div>
                </div>

                <!-- æµ‹è¯•å®Œæˆç»“æœ -->
                <div id="mastery-test-result" class="hidden">
                    <div class="level-result">
                        <div class="level-badge">ğŸ¯</div>
                        <h3>æŒæ¡åº¦æµ‹è¯•å®Œæˆï¼</h3>
                        <div class="stats">
                            <div class="stat-item">
                                <div class="stat-number" id="mastered-count">0</div>
                                <div class="stat-label">å®Œå…¨æŒæ¡</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="need-review-count">0</div>
                                <div class="stat-label">éœ€è¦å¤ä¹ </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="test-accuracy">0%</div>
                                <div class="stat-label">æµ‹è¯•å‡†ç¡®ç‡</div>
                            </div>
                        </div>
                        
                        <div id="mastery-details" style="margin: 20px 0; text-align: left;"></div>
                        
                        <button class="btn" onclick="finishMasteryTest()">å®Œæˆæµ‹è¯•</button>
                        <button class="btn" onclick="retestWeakWords()" id="retest-btn" class="hidden">é‡æµ‹è–„å¼±å•è¯</button>
                    </div>
                </div>
                
                <!-- æŒæ¡åº¦æµ‹è¯•ç•Œé¢ -->
                <div id="mastery-test" class="hidden">
                    <div class="word-card">
                        <div class="text-center">
                            <h3>ğŸ¯ æŒæ¡åº¦æµ‹è¯•</h3>
                            <div class="progress-bar">
                                <div class="progress-fill" id="test-progress" style="width: 0%"></div>
                            </div>
                            <p>é¢˜ç›® <span id="test-question-num">1</span> / <span id="test-total-questions">20</span></p>
                        </div>
                        
                        <div class="word-title" id="test-word" style="text-align: center; margin: 30px 0;">abandon</div>
                        <div class="word-translation" style="text-align: center; margin-bottom: 30px;">è¯·é€‰æ‹©æ­£ç¡®çš„ä¸­æ–‡é‡Šä¹‰ï¼š</div>
                        
                        <div id="test-options" style="max-width: 500px; margin: 0 auto;"></div>
                        
                        <div id="test-feedback" class="hidden" style="text-align: center; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <div id="feedback-text"></div>
                            <button class="btn" onclick="nextTestQuestion()" style="margin-top: 15px;">ä¸‹ä¸€é¢˜</button>
                        </div>
                    </div>
                </div>
                
                <!-- æŒæ¡åº¦æµ‹è¯•ç»“æœ -->
                <div id="mastery-test-result" class="hidden">
                    <div class="level-result">
                        <div class="level-badge">ğŸ¯</div>
                        <h3>æŒæ¡åº¦æµ‹è¯•å®Œæˆï¼</h3>
                        <p>æµ‹è¯•ç»“æœç»Ÿè®¡</p>
                        <div class="stats">
                            <div class="stat-item">
                                <div class="stat-number" id="mastered-count">0</div>
                                <div class="stat-label">å®Œå…¨æŒæ¡</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="need-review-count">0</div>
                                <div class="stat-label">éœ€è¦å¤ä¹ </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="test-accuracy">0%</div>
                                <div class="stat-label">æµ‹è¯•å‡†ç¡®ç‡</div>
                            </div>
                        </div>
                        
                        <div id="mastery-details" style="text-align: left; margin: 20px 0; padding: 20px; background: rgba(255,255,255,0.2); border-radius: 10px;"></div>
                        
                        <button class="btn" onclick="finishMasteryTest()">å®Œæˆæµ‹è¯•</button>
                        <button class="btn" id="retest-btn" onclick="retestWeakWords()" class="hidden" style="background: #FF9800;">é‡æµ‹è–„å¼±å•è¯</button>
                    </div>
                </div>
            </div>

            <!-- å¤ä¹ ç®¡ç† -->
            <div id="review" class="tab-content">
                <h2>ğŸ”„ æ™ºèƒ½å¤ä¹ ç®¡ç†</h2>
                <p>åŸºäºè‰¾å®¾æµ©æ–¯é—å¿˜æ›²çº¿ï¼Œç§‘å­¦å®‰æ’å¤ä¹ æ—¶é—´</p>
                
                <div class="review-schedule" id="review-schedule">
                    <!-- å¤ä¹ é¡¹ç›®å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div class="text-center">
                    <button class="btn" onclick="startReview()">å¼€å§‹å¤ä¹ </button>
                    <button class="btn" onclick="clearReviewData()">æ¸…é™¤å¤ä¹ æ•°æ®</button>
                </div>
            </div>

            <!-- å­¦ä¹ ç»Ÿè®¡ -->
            <div id="stats" class="tab-content">
                <h2>ğŸ“ˆ å­¦ä¹ ç»Ÿè®¡</h2>
                
                <div class="stats" id="learning-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="total-learned">0</div>
                        <div class="stat-label">å·²å­¦å•è¯</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="total-reviewed">0</div>
                        <div class="stat-label">å·²å¤ä¹ æ¬¡æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="study-days">0</div>
                        <div class="stat-label">å­¦ä¹ å¤©æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="current-streak">0</div>
                        <div class="stat-label">è¿ç»­å­¦ä¹ </div>
                    </div>
                </div>
                
                <div class="study-plan">
                    <h3>ğŸ“Š å­¦ä¹ è¿›åº¦</h3>
                    <div id="progress-charts"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è¯æ±‡æ•°æ®å­˜å‚¨
        let vocabularyData = {};
        let currentTest = {
            questions: [],
            currentIndex: 0,
            correctAnswers: 0,
            userLevel: 0
        };
        
        // å­¦ä¹ æ•°æ®
        let learningData = {
            userLevel: 0,
            studyPlan: [],
            reviewSchedule: [],
            learnedWords: [],
            stats: {
                totalLearned: 0,
                totalReviewed: 0,
                studyDays: 0,
                currentStreak: 0,
                lastStudyDate: null
            }
        };
        
        // è¯æ±‡çº§åˆ«å®šä¹‰
        const levels = {
            1: { name: 'åˆä¸­', file: '1-åˆä¸­-é¡ºåº.json', vocab: 1500, description: 'æŒæ¡åŸºç¡€è¯æ±‡ï¼Œèƒ½è¿›è¡Œç®€å•äº¤æµ' },
            2: { name: 'é«˜ä¸­', file: '2-é«˜ä¸­-é¡ºåº.json', vocab: 3500, description: 'è¯æ±‡é‡è¾¾åˆ°é«˜ä¸­æ°´å¹³ï¼Œèƒ½ç†è§£ä¸€èˆ¬æ–‡ç« ' },
            3: { name: 'CET4', file: '3-CET4-é¡ºåº.json', vocab: 4500, description: 'è¾¾åˆ°å¤§å­¦è‹±è¯­å››çº§æ°´å¹³' },
            4: { name: 'CET6', file: '4-CET6-é¡ºåº.json', vocab: 6000, description: 'è¾¾åˆ°å¤§å­¦è‹±è¯­å…­çº§æ°´å¹³' },
            5: { name: 'æ‰˜ç¦', file: '6-æ‰˜ç¦-é¡ºåº.json', vocab: 8000, description: 'å…·å¤‡æ‰˜ç¦è€ƒè¯•æ‰€éœ€è¯æ±‡é‡' },
            6: { name: 'SAT', file: '7-SAT-é¡ºåº.json', vocab: 12000, description: 'è¾¾åˆ°SATè€ƒè¯•é«˜åˆ†æ°´å¹³' }
        };
        
        // é—å¿˜æ›²çº¿é—´éš”ï¼ˆå¤©ï¼‰
        const forgettingCurve = [1, 3, 7, 15, 30, 60];
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadVocabularyData();
            loadLearningData();
            updateStats();
            updateReviewSchedule();
            initializeSpeech(); // æ·»åŠ è¿™è¡Œ
        });
        
        // åŠ è½½è¯æ±‡æ•°æ®
        async function loadVocabularyData() {
            try {
                for (let level in levels) {
                    const response = await fetch(levels[level].file);
                    const data = await response.json();
                    vocabularyData[level] = data;
                }
                console.log('è¯æ±‡æ•°æ®åŠ è½½å®Œæˆ');
            } catch (error) {
                console.error('åŠ è½½è¯æ±‡æ•°æ®å¤±è´¥:', error);
                alert('åŠ è½½è¯æ±‡æ•°æ®å¤±è´¥ï¼Œè¯·ç¡®ä¿JSONæ–‡ä»¶åœ¨æ­£ç¡®ä½ç½®');
            }
        }
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            document.getElementById(tabName).classList.add('active');
            
            // æ·»åŠ activeç±»åˆ°é€‰ä¸­çš„æ ‡ç­¾
            event.target.classList.add('active');
            
            // æ›´æ–°ç›¸åº”å†…å®¹
            if (tabName === 'stats') {
                updateStats();
            } else if (tabName === 'review') {
                updateReviewSchedule();
            }
        }
        
        // å¼€å§‹æµ‹è¯•
        function startTest() {
            currentTest = {
                questions: [],
                currentIndex: 0,
                correctAnswers: 0,
                userLevel: 0
            };
            
            generateTestQuestions();
            showQuestion();
            
            document.getElementById('test-start').classList.add('hidden');
            document.getElementById('test-question').classList.remove('hidden');
            document.getElementById('test-result').classList.add('hidden');
        }
        
        // ç”Ÿæˆæµ‹è¯•é¢˜ç›®
        function generateTestQuestions() {
            const totalQuestions = 20;
            currentTest.questions = [];
            
            // ä»å„ä¸ªçº§åˆ«éšæœºé€‰æ‹©å•è¯
            for (let i = 0; i < totalQuestions; i++) {
                const level = Math.floor(Math.random() * 6) + 1;
                const words = vocabularyData[level];
                if (words && words.length > 0) {
                    const randomWord = words[Math.floor(Math.random() * words.length)];
                    const question = createQuestion(randomWord, level);
                    currentTest.questions.push(question);
                }
            }
        }
        
        // åˆ›å»ºå•ä¸ªé—®é¢˜
        function createQuestion(wordData, level) {
            const correctTranslation = wordData.translations[0].translation;
            const options = [correctTranslation];
            
            // ç”Ÿæˆ3ä¸ªé”™è¯¯é€‰é¡¹
            while (options.length < 4) {
                const randomLevel = Math.floor(Math.random() * 6) + 1;
                const randomWords = vocabularyData[randomLevel];
                if (randomWords && randomWords.length > 0) {
                    const randomWord = randomWords[Math.floor(Math.random() * randomWords.length)];
                    const randomTranslation = randomWord.translations[0].translation;
                    if (!options.includes(randomTranslation)) {
                        options.push(randomTranslation);
                    }
                }
            }
            
            // æ‰“ä¹±é€‰é¡¹é¡ºåº
            for (let i = options.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [options[i], options[j]] = [options[j], options[i]];
            }
            
            return {
                word: wordData.word,
                correctAnswer: correctTranslation,
                options: options,
                level: level,
                answered: false,
                correct: false
            };
        }
        
        // æ˜¾ç¤ºé—®é¢˜
        function showQuestion() {
            const question = currentTest.questions[currentTest.currentIndex];
            
            document.getElementById('test-word-text').textContent = question.word;
            document.getElementById('question-num').textContent = currentTest.currentIndex + 1;
            document.getElementById('total-questions').textContent = currentTest.questions.length;
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option;
                optionElement.onclick = () => selectOption(index, option);
                optionsContainer.appendChild(optionElement);
            });
            
            document.getElementById('next-btn').disabled = true;
            
            // æ›´æ–°è¿›åº¦æ¡
            const progress = ((currentTest.currentIndex + 1) / currentTest.questions.length) * 100;
            document.getElementById('test-progress').style.width = progress + '%';
        }
        
        // æµ‹è¯•ç•Œé¢è¯­éŸ³æ’­æ”¾åŠŸèƒ½
        function speakTestWord() {
            const wordText = document.getElementById('test-word-text').textContent;
            
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯­éŸ³åˆæˆ
            if ('speechSynthesis' in window) {
                // åœæ­¢å½“å‰æ’­æ”¾çš„è¯­éŸ³
                speechSynthesis.cancel();
                
                // åˆ›å»ºè¯­éŸ³åˆæˆå®ä¾‹
                const utterance = new SpeechSynthesisUtterance(wordText);
                
                // è®¾ç½®è¯­éŸ³å‚æ•°
                utterance.lang = 'en-US'; // ç¾å¼è‹±è¯­
                utterance.rate = 0.8; // è¯­é€Ÿç¨æ…¢ï¼Œä¾¿äºå­¦ä¹ 
                utterance.pitch = 1; // éŸ³è°ƒ
                utterance.volume = 1; // éŸ³é‡
                
                // æ’­æ”¾è¯­éŸ³
                speechSynthesis.speak(utterance);
            } else {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åŠŸèƒ½ï¼Œå»ºè®®ä½¿ç”¨Chromeã€Firefoxæˆ–Safariæµè§ˆå™¨ã€‚');
            }
        }
        
        // é€‰æ‹©é€‰é¡¹
        function selectOption(index, selectedAnswer) {
            const question = currentTest.questions[currentTest.currentIndex];
            const options = document.querySelectorAll('.option');
            
            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            options.forEach(option => {
                option.classList.remove('selected', 'correct', 'wrong');
            });
            
            // æ ‡è®°é€‰ä¸­çš„é€‰é¡¹
            options[index].classList.add('selected');
            
            // æ£€æŸ¥ç­”æ¡ˆ
            const isCorrect = selectedAnswer === question.correctAnswer;
            question.answered = true;
            question.correct = isCorrect;
            
            if (isCorrect) {
                options[index].classList.add('correct');
                currentTest.correctAnswers++;
            } else {
                options[index].classList.add('wrong');
                // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
                options.forEach(option => {
                    if (option.textContent === question.correctAnswer) {
                        option.classList.add('correct');
                    }
                });
            }
            
            document.getElementById('next-btn').disabled = false;
        }
        
        // ä¸‹ä¸€é¢˜
        function nextQuestion() {
            currentTest.currentIndex++;
            
            if (currentTest.currentIndex < currentTest.questions.length) {
                showQuestion();
            } else {
                showTestResult();
            }
        }
        
        // è·³è¿‡é—®é¢˜
        function skipQuestion() {
            const question = currentTest.questions[currentTest.currentIndex];
            question.answered = true;
            question.correct = false;
            nextQuestion();
        }
        
        // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
        function showTestResult() {
            const accuracy = (currentTest.correctAnswers / currentTest.questions.length) * 100;
            
            // æ ¹æ®æ­£ç¡®ç‡å’Œç­”å¯¹çš„é«˜çº§è¯æ±‡ç¡®å®šç”¨æˆ·çº§åˆ«
            let userLevel = 1;
            if (accuracy >= 80) userLevel = 6;
            else if (accuracy >= 70) userLevel = 5;
            else if (accuracy >= 60) userLevel = 4;
            else if (accuracy >= 50) userLevel = 3;
            else if (accuracy >= 40) userLevel = 2;
            
            currentTest.userLevel = userLevel;
            learningData.userLevel = userLevel;
            
            const level = levels[userLevel];
            
            document.getElementById('result-level').textContent = level.name;
            document.getElementById('result-title').textContent = `æ‚¨çš„è¯æ±‡æ°´å¹³ï¼š${level.name}`;
            document.getElementById('result-description').textContent = level.description;
            document.getElementById('correct-count').textContent = currentTest.correctAnswers;
            document.getElementById('accuracy-rate').textContent = Math.round(accuracy) + '%';
            document.getElementById('estimated-vocab').textContent = level.vocab;
            
            document.getElementById('test-question').classList.add('hidden');
            document.getElementById('test-result').classList.remove('hidden');
            
            saveLearningData();
        }
        
        // é‡æ–°å¼€å§‹æµ‹è¯•
        function restartTest() {
            document.getElementById('test-result').classList.add('hidden');
            document.getElementById('test-start').classList.remove('hidden');
            document.getElementById('test-progress').style.width = '0%';
        }
        
        // ç”Ÿæˆå­¦ä¹ è®¡åˆ’
        function generateStudyPlan() {
            const userLevel = learningData.userLevel;
            const plan = [];
            
            // ä¸ºå½“å‰çº§åˆ«å’Œä¸‹ä¸€çº§åˆ«ç”Ÿæˆå­¦ä¹ è®¡åˆ’
            for (let level = userLevel; level <= Math.min(userLevel + 1, 6); level++) {
                const levelData = levels[level];
                const words = vocabularyData[level] || [];
                
                plan.push({
                    level: level,
                    name: levelData.name,
                    totalWords: words.length,
                    dailyTarget: 20,
                    estimatedDays: Math.ceil(words.length / 20),
                    words: words
                });
            }
            
            learningData.studyPlan = plan;
            saveLearningData();
            
            // åˆ‡æ¢åˆ°å­¦ä¹ è®¡åˆ’æ ‡ç­¾
            switchTab('study');
            updateStudyPlan();
        }
        
        // æ›´æ–°å­¦ä¹ è®¡åˆ’æ˜¾ç¤º
        function updateStudyPlan() {
            if (learningData.studyPlan.length === 0) {
                document.getElementById('no-plan').classList.remove('hidden');
                document.getElementById('study-plan-content').classList.add('hidden');
                return;
            }
            
            document.getElementById('no-plan').classList.add('hidden');
            document.getElementById('study-plan-content').classList.remove('hidden');
            
            const currentLevel = levels[learningData.userLevel];
            document.getElementById('current-goal').innerHTML = `
                <div class="plan-item">
                    <div>
                        <strong>ç›®æ ‡çº§åˆ«ï¼š${currentLevel.name}</strong><br>
                        <span>ç›®æ ‡è¯æ±‡é‡ï¼š${currentLevel.vocab} è¯</span>
                    </div>
                    <div class="stat-number">${Math.round((learningData.stats.totalLearned / currentLevel.vocab) * 100)}%</div>
                </div>
            `;
            
            const planList = document.getElementById('plan-list');
            planList.innerHTML = '';
            
            learningData.studyPlan.forEach(plan => {
                const planElement = document.createElement('div');
                planElement.className = 'plan-item';
                planElement.innerHTML = `
                    <div>
                        <strong>${plan.name} çº§åˆ«</strong><br>
                        <span>å…± ${plan.totalWords} è¯ï¼Œæ¯æ—¥ ${plan.dailyTarget} è¯ï¼Œé¢„è®¡ ${plan.estimatedDays} å¤©</span>
                    </div>
                    <button class="btn" onclick="startLevelStudy(${plan.level})">å¼€å§‹å­¦ä¹ </button>
                `;
                planList.appendChild(planElement);
            });
            
            updateDailyWords();
        }
        
        // æ›´æ–°ä»Šæ—¥å­¦ä¹ å•è¯
        function updateDailyWords() {
            const dailyWordsContainer = document.getElementById('daily-words');
            const today = new Date().toDateString();
            
            // è·å–ä»Šæ—¥åº”å­¦ä¹ çš„å•è¯
            const todayWords = getTodayWords();
            
            if (todayWords.length === 0) {
                dailyWordsContainer.innerHTML = '<p>ä»Šæ—¥å­¦ä¹ ä»»åŠ¡å·²å®Œæˆï¼</p>';
                return;
            }
            
            dailyWordsContainer.innerHTML = `
                <p>ä»Šæ—¥éœ€è¦å­¦ä¹  ${todayWords.length} ä¸ªæ–°å•è¯</p>
                <div class="word-preview">
                    ${todayWords.slice(0, 5).map(word => `<span class="word-tag">${word.word}</span>`).join('')}
                    ${todayWords.length > 5 ? '...' : ''}
                </div>
            `;
        }
        
        // è·å–ä»Šæ—¥åº”å­¦ä¹ çš„å•è¯
        function getTodayWords() {
            const dailyTarget = 20;
            const learnedWords = learningData.learnedWords.map(w => w.word);
            
            for (let plan of learningData.studyPlan) {
                const unlearned = plan.words.filter(word => !learnedWords.includes(word.word));
                if (unlearned.length > 0) {
                    return unlearned.slice(0, dailyTarget);
                }
            }
            
            return [];
        }
        
        // å¼€å§‹ä»Šæ—¥å­¦ä¹ 
        function startDailyStudy() {
            const todayWords = getTodayWords();
            if (todayWords.length === 0) {
                alert('ä»Šæ—¥å­¦ä¹ ä»»åŠ¡å·²å®Œæˆï¼');
                return;
            }
            
            // ä½¿ç”¨å­¦ä¹ ç•Œé¢
            currentStudySession = {
                words: todayWords,
                currentIndex: 0,
                knownWords: [],
                unknownWords: [],
                level: learningData.userLevel,
                levelName: 'ä»Šæ—¥å­¦ä¹ '
            };
            
            showStudySession();
        }
        
        // æ·»åŠ åˆ°å·²å­¦ä¹ å•è¯
        function addToLearned(wordData, masteryLevel = 'learned') {
            const learnedWord = {
                word: wordData.word,
                translation: wordData.translations[0].translation,
                level: getCurrentWordLevel(wordData.word),
                learnDate: new Date().toISOString(),
                reviewCount: 0,
                nextReview: getNextReviewDate(0),
                masteryLevel: masteryLevel // 'learned', 'mastered'
            };
            
            // é¿å…é‡å¤æ·»åŠ 
            const existing = learningData.learnedWords.find(w => w.word === wordData.word);
            if (!existing) {
                learningData.learnedWords.push(learnedWord);
                learningData.stats.totalLearned++;
            }
            
            saveLearningData();
        }
        
        // è·å–å•è¯æ‰€å±çº§åˆ«
        function getCurrentWordLevel(word) {
            for (let level in vocabularyData) {
                if (vocabularyData[level].some(w => w.word === word)) {
                    return parseInt(level);
                }
            }
            return 1;
        }
        
        // è·å–ä¸‹æ¬¡å¤ä¹ æ—¥æœŸ
        function getNextReviewDate(reviewCount) {
            const days = forgettingCurve[Math.min(reviewCount, forgettingCurve.length - 1)];
            const nextDate = new Date();
            nextDate.setDate(nextDate.getDate() + days);
            return nextDate.toISOString();
        }
        
        // å½“å‰å­¦ä¹ ä¼šè¯æ•°æ®
        let currentStudySession = {
            words: [],
            currentIndex: 0,
            knownWords: [],
            unknownWords: [],
            level: 1,
            levelName: '',
            // æµ‹è¯•ç›¸å…³æ•°æ®
            testMode: false,
            testWords: [],
            testCurrentIndex: 0,
            testResults: {}, // è®°å½•æ¯ä¸ªå•è¯çš„æµ‹è¯•ç»“æœ
            masteredWords: [], // è¿ç»­3æ¬¡æ­£ç¡®çš„å•è¯
            needRetestWords: [] // éœ€è¦é‡æ–°æµ‹è¯•çš„å•è¯
        };
        
        // å¼€å§‹æŒ‡å®šçº§åˆ«çš„å­¦ä¹ 
        function startLevelStudy(level) {
            const levelData = levels[level];
            const words = vocabularyData[level] || [];
            
            if (words.length === 0) {
                alert(`${levelData.name} çº§åˆ«çš„è¯æ±‡æ•°æ®æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•`);
                return;
            }
            
            // è·å–è¯¥çº§åˆ«æœªå­¦ä¹ çš„å•è¯
            const learnedWords = learningData.learnedWords.map(w => w.word);
            const unlearnedWords = words.filter(word => !learnedWords.includes(word.word));
            
            if (unlearnedWords.length === 0) {
                alert(`æ­å–œï¼æ‚¨å·²å®Œæˆ ${levelData.name} çº§åˆ«çš„æ‰€æœ‰å•è¯å­¦ä¹ ï¼`);
                return;
            }
            
            // åˆå§‹åŒ–å­¦ä¹ ä¼šè¯
            currentStudySession = {
                words: unlearnedWords.slice(0, 20), // æ¯æ¬¡å­¦ä¹ 20ä¸ªå•è¯
                currentIndex: 0,
                knownWords: [],
                unknownWords: [],
                level: level,
                levelName: levelData.name
            };
            
            // æ˜¾ç¤ºå­¦ä¹ ç•Œé¢
            showStudySession();
        }
        
        // æ˜¾ç¤ºå­¦ä¹ ç•Œé¢
        function showStudySession() {
            // éšè—å­¦ä¹ è®¡åˆ’ï¼Œæ˜¾ç¤ºå­¦ä¹ ç•Œé¢
            document.getElementById('study-plan-content').classList.add('hidden');
            document.getElementById('study-session').classList.remove('hidden');
            document.getElementById('study-result').classList.add('hidden');
            
            // æ›´æ–°ç•Œé¢ä¿¡æ¯
            document.getElementById('study-level-title').textContent = `æ­£åœ¨å­¦ä¹ ï¼š${currentStudySession.levelName} çº§åˆ«`;
            document.getElementById('study-total-words').textContent = currentStudySession.words.length;
            
            // æ˜¾ç¤ºå½“å‰å•è¯
            showCurrentStudyWord();
        }
        
        // æ˜¾ç¤ºå½“å‰å­¦ä¹ å•è¯
        function showCurrentStudyWord() {
            const word = currentStudySession.words[currentStudySession.currentIndex];
            
            // æ›´æ–°å•è¯æ˜¾ç¤ºï¼ˆåŒ…å«å‘éŸ³æŒ‰é’®ï¼‰
            document.getElementById('study-current-word').innerHTML = `
                <span>${word.word}</span>
                <button class="btn" onclick="speakWord()" style="padding: 8px 15px; font-size: 14px; background: #2196F3;">ğŸ”Š å‘éŸ³</button>
            `;
            
            document.getElementById('study-word-translation').textContent = word.translations[0].translation;
            
            // æ˜¾ç¤ºä¾‹å¥ï¼ˆå¦‚æœæœ‰ï¼‰
            const phrasesContainer = document.getElementById('study-word-phrases');
            if (word.phrases && word.phrases.length > 0) {
                phrasesContainer.textContent = `ä¾‹å¥: ${word.phrases[0].phrase}`;
                phrasesContainer.style.display = 'block';
            } else {
                phrasesContainer.style.display = 'none';
            }
            
            // æ›´æ–°è¿›åº¦
            document.getElementById('study-word-num').textContent = currentStudySession.currentIndex + 1;
            const progress = ((currentStudySession.currentIndex + 1) / currentStudySession.words.length) * 100;
            document.getElementById('study-progress').style.width = progress + '%';
            
            // è‡ªåŠ¨å‘éŸ³ï¼ˆå¯é€‰ï¼Œå¦‚æœä¸éœ€è¦å¯ä»¥æ³¨é‡Šæ‰ï¼‰
            autoSpeakCurrentWord();
        }
        
        // è¯­éŸ³åˆæˆç›¸å…³
        let speechSynthesis = window.speechSynthesis;
        let currentVoice = null;
        
        // åˆå§‹åŒ–è¯­éŸ³
        function initializeSpeech() {
            // ç­‰å¾…è¯­éŸ³åˆ—è¡¨åŠ è½½å®Œæˆ
            if (speechSynthesis.getVoices().length === 0) {
                speechSynthesis.addEventListener('voiceschanged', selectEnglishVoice);
            } else {
                selectEnglishVoice();
            }
        }
        
        // é€‰æ‹©è‹±è¯­è¯­éŸ³
        function selectEnglishVoice() {
            const voices = speechSynthesis.getVoices();
            
            // ä¼˜å…ˆé€‰æ‹©è‹±è¯­è¯­éŸ³ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº
            const preferredVoices = [
                'Alex',           // macOS è‹±è¯­ç”·å£°
                'Samantha',       // macOS è‹±è¯­å¥³å£°
                'Google US English', // Chrome è‹±è¯­
                'Microsoft David',   // Windows è‹±è¯­
                'Microsoft Zira'     // Windows è‹±è¯­
            ];
            
            // æŸ¥æ‰¾é¦–é€‰è¯­éŸ³
            for (let preferred of preferredVoices) {
                const voice = voices.find(v => v.name.includes(preferred));
                if (voice) {
                    currentVoice = voice;
                    console.log('é€‰æ‹©è¯­éŸ³:', voice.name);
                    return;
                }
            }
            
            // å¦‚æœæ²¡æ‰¾åˆ°é¦–é€‰è¯­éŸ³ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªè‹±è¯­è¯­éŸ³
            const englishVoice = voices.find(v => 
                v.lang.startsWith('en') && 
                (v.lang.includes('US') || v.lang.includes('GB'))
            );
            
            if (englishVoice) {
                currentVoice = englishVoice;
                console.log('é€‰æ‹©è‹±è¯­è¯­éŸ³:', englishVoice.name);
            } else {
                console.log('æœªæ‰¾åˆ°è‹±è¯­è¯­éŸ³ï¼Œä½¿ç”¨é»˜è®¤è¯­éŸ³');
            }
        }
        
        // å‘éŸ³å‡½æ•°
        function speakWord(word) {
            // å¦‚æœæ²¡æœ‰ä¼ å…¥å•è¯ï¼Œä½¿ç”¨å½“å‰æ˜¾ç¤ºçš„å•è¯
            if (!word) {
                const wordElement = document.getElementById('study-current-word');
                if (wordElement) {
                    // æå–å•è¯æ–‡æœ¬ï¼ˆå»é™¤å‘éŸ³æŒ‰é’®ï¼‰
                    const wordSpan = wordElement.querySelector('span');
                    word = wordSpan ? wordSpan.textContent : wordElement.textContent.split('ğŸ”Š')[0].trim();
                }
            }
            
            if (!word) {
                console.log('æ²¡æœ‰æ‰¾åˆ°è¦å‘éŸ³çš„å•è¯');
                return;
            }
            
            // åœæ­¢å½“å‰æ’­æ”¾çš„è¯­éŸ³
            speechSynthesis.cancel();
            
            // åˆ›å»ºè¯­éŸ³åˆæˆå®ä¾‹
            const utterance = new SpeechSynthesisUtterance(word);
            
            // è®¾ç½®è¯­éŸ³å‚æ•°
            if (currentVoice) {
                utterance.voice = currentVoice;
            }
            utterance.lang = 'en-US';  // è®¾ç½®ä¸ºç¾å¼è‹±è¯­
            utterance.rate = 0.8;      // è¯­é€Ÿç¨æ…¢ï¼Œä¾¿äºå­¦ä¹ 
            utterance.pitch = 1.0;     // æ­£å¸¸éŸ³è°ƒ
            utterance.volume = 1.0;    // æœ€å¤§éŸ³é‡
            
            // å‘éŸ³äº‹ä»¶å¤„ç†
            utterance.onstart = function() {
                console.log('å¼€å§‹å‘éŸ³:', word);
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è§†è§‰åé¦ˆï¼Œæ¯”å¦‚æŒ‰é’®å˜è‰²
                const speakBtn = document.querySelector('button[onclick="speakWord()"]');
                if (speakBtn) {
                    speakBtn.style.background = '#4CAF50';
                    speakBtn.textContent = 'ğŸ”Š æ’­æ”¾ä¸­...';
                }
            };
            
            utterance.onend = function() {
                console.log('å‘éŸ³ç»“æŸ:', word);
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const speakBtn = document.querySelector('button[onclick="speakWord()"]');
                if (speakBtn) {
                    speakBtn.style.background = '#2196F3';
                    speakBtn.textContent = 'ğŸ”Š å‘éŸ³';
                }
            };
            
            utterance.onerror = function(event) {
                console.error('å‘éŸ³é”™è¯¯:', event.error);
                alert('å‘éŸ³åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®');
            };
            
            // å¼€å§‹å‘éŸ³
            speechSynthesis.speak(utterance);
        }
        
        // è‡ªåŠ¨å‘éŸ³ï¼ˆå¯é€‰ï¼‰
        function autoSpeakCurrentWord() {
            // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ï¼Œç¡®ä¿ç•Œé¢æ›´æ–°å®Œæˆ
            setTimeout(() => {
                speakWord();
            }, 500);
        }
        

        
        // æ ‡è®°å•è¯è®¤è¯†çŠ¶æ€
        function markWordKnown(isKnown) {
            const word = currentStudySession.words[currentStudySession.currentIndex];
            
            if (isKnown) {
                currentStudySession.knownWords.push(word);
                // è®¤è¯†çš„è¯ç›´æ¥æ·»åŠ åˆ°å·²å­¦ä¹ åˆ—è¡¨
                addToLearned(word);
            } else {
                currentStudySession.unknownWords.push(word);
            }
            
            nextStudyWord();
        }
        
        // è·³è¿‡å½“å‰å•è¯
        function skipStudyWord() {
            // è·³è¿‡çš„å•è¯è§†ä¸ºä¸è®¤è¯†
            const word = currentStudySession.words[currentStudySession.currentIndex];
            currentStudySession.unknownWords.push(word);
            nextStudyWord();
        }
        
        // ä¸‹ä¸€ä¸ªå­¦ä¹ å•è¯
        function nextStudyWord() {
            currentStudySession.currentIndex++;
            
            if (currentStudySession.currentIndex < currentStudySession.words.length) {
                showCurrentStudyWord();
            } else {
                showStudyResult();
            }
        }
        
        // æ˜¾ç¤ºå­¦ä¹ ç»“æœ
        function showStudyResult() {
            document.getElementById('study-session').classList.add('hidden');
            document.getElementById('study-result').classList.remove('hidden');
            
            const knownCount = currentStudySession.knownWords.length;
            const unknownCount = currentStudySession.unknownWords.length;
            const totalCount = currentStudySession.words.length;
            const masteryRate = Math.round((knownCount / totalCount) * 100);
            
            document.getElementById('study-result-title').textContent = `${currentStudySession.levelName} çº§åˆ«å­¦ä¹ å®Œæˆï¼`;
            document.getElementById('study-result-description').textContent = `æœ¬æ¬¡å­¦ä¹ äº† ${totalCount} ä¸ªå•è¯ï¼ŒæŒæ¡ç‡ ${masteryRate}%`;
            document.getElementById('study-known-count').textContent = knownCount;
            document.getElementById('study-unknown-count').textContent = unknownCount;
            document.getElementById('study-mastery-rate').textContent = masteryRate + '%';
            
            // æ·»åŠ æµ‹è¯•æŒ‰é’®
            const resultContainer = document.querySelector('#study-result .level-result');
            const existingTestBtn = document.getElementById('start-mastery-test-btn');
            if (!existingTestBtn && knownCount > 0) {
                const testButton = document.createElement('button');
                testButton.id = 'start-mastery-test-btn';
                testButton.className = 'btn';
                testButton.style.background = '#FF9800';
                testButton.style.marginTop = '15px';
                testButton.textContent = `å¼€å§‹æŒæ¡åº¦æµ‹è¯• (${knownCount}ä¸ªå•è¯)`;
                testButton.onclick = startMasteryTest;
                
                const finishBtn = resultContainer.querySelector('button[onclick="finishStudySession()"]');
                resultContainer.insertBefore(testButton, finishBtn);
            }
        }
        
        // å¼€å§‹æŒæ¡åº¦æµ‹è¯•
        function startMasteryTest() {
            // åˆå§‹åŒ–æµ‹è¯•æ•°æ®
            currentStudySession.testMode = true;
            currentStudySession.testWords = [...currentStudySession.knownWords];
            currentStudySession.testCurrentIndex = 0;
            currentStudySession.testResults = {};
            currentStudySession.masteredWords = [];
            currentStudySession.needRetestWords = [];
            
            // ä¸ºæ¯ä¸ªå•è¯åˆå§‹åŒ–æµ‹è¯•è®°å½•
            currentStudySession.testWords.forEach(word => {
                currentStudySession.testResults[word.word] = {
                    attempts: 0,
                    correctCount: 0,
                    consecutiveCorrect: 0,
                    isMastered: false
                };
            });
            
            // æ˜¾ç¤ºæµ‹è¯•ç•Œé¢
            document.getElementById('study-result').classList.add('hidden');
            document.getElementById('mastery-test').classList.remove('hidden');
            
            showTestQuestion();
        }
        
        // æ˜¾ç¤ºæµ‹è¯•é¢˜ç›®
        function showTestQuestion() {
            if (currentStudySession.testCurrentIndex >= currentStudySession.testWords.length) {
                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æœªæŒæ¡çš„å•è¯éœ€è¦é‡æµ‹
                const needRetest = currentStudySession.testWords.filter(word => 
                    !currentStudySession.testResults[word.word].isMastered
                );
                
                if (needRetest.length > 0) {
                    // é‡æ–°æµ‹è¯•æœªæŒæ¡çš„å•è¯
                    currentStudySession.testWords = needRetest;
                    currentStudySession.testCurrentIndex = 0;
                    showTestQuestion();
                    return;
                } else {
                    // æ‰€æœ‰å•è¯éƒ½æµ‹è¯•å®Œæˆ
                    showMasteryTestResult();
                    return;
                }
            }
            
            const currentWord = currentStudySession.testWords[currentStudySession.testCurrentIndex];
            const wordResult = currentStudySession.testResults[currentWord.word];
            
            // å¦‚æœå·²ç»æŒæ¡ï¼Œè·³åˆ°ä¸‹ä¸€ä¸ª
            if (wordResult.isMastered) {
                currentStudySession.testCurrentIndex++;
                showTestQuestion();
                return;
            }
            
            // æ›´æ–°ç•Œé¢
            document.getElementById('test-word').textContent = currentWord.word;
            document.getElementById('test-question-num').textContent = currentStudySession.testCurrentIndex + 1;
            document.getElementById('test-total-questions').textContent = currentStudySession.testWords.length;
            
            // æ›´æ–°è¿›åº¦æ¡
            const progress = ((currentStudySession.testCurrentIndex + 1) / currentStudySession.testWords.length) * 100;
            document.getElementById('test-progress').style.width = progress + '%';
            
            // ç”Ÿæˆé€‰é¡¹
            generateTestOptions(currentWord);
            
            // éšè—åé¦ˆ
            document.getElementById('test-feedback').classList.add('hidden');
        }
        
        // ç”Ÿæˆæµ‹è¯•é€‰é¡¹
        function generateTestOptions(currentWord) {
            const correctAnswer = currentWord.translations[0].translation;
            const options = [correctAnswer];
            
            // ä»å…¶ä»–å•è¯ä¸­éšæœºé€‰æ‹©3ä¸ªé”™è¯¯é€‰é¡¹
            const allWords = Object.values(vocabularyData).flat();
            const wrongOptions = [];
            
            while (wrongOptions.length < 3) {
                const randomWord = allWords[Math.floor(Math.random() * allWords.length)];
                const wrongAnswer = randomWord.translations[0].translation;
                
                if (wrongAnswer !== correctAnswer && !wrongOptions.includes(wrongAnswer)) {
                    wrongOptions.push(wrongAnswer);
                }
            }
            
            options.push(...wrongOptions);
            
            // æ‰“ä¹±é€‰é¡¹é¡ºåº
            for (let i = options.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [options[i], options[j]] = [options[j], options[i]];
            }
            
            // ç”Ÿæˆé€‰é¡¹HTML
            const optionsContainer = document.getElementById('test-options');
            optionsContainer.innerHTML = '';
            
            options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'btn test-option';
                button.style.cssText = 'display: block; width: 100%; margin: 10px 0; padding: 15px; font-size: 16px;';
                button.textContent = option;
                button.onclick = () => selectTestOption(option, correctAnswer);
                optionsContainer.appendChild(button);
            });
        }
        
        // é€‰æ‹©æµ‹è¯•é€‰é¡¹
        function selectTestOption(selectedOption, correctAnswer) {
            const currentWord = currentStudySession.testWords[currentStudySession.testCurrentIndex];
            const wordResult = currentStudySession.testResults[currentWord.word];
            
            wordResult.attempts++;
            
            const isCorrect = selectedOption === correctAnswer;
            const feedbackElement = document.getElementById('feedback-text');
            
            if (isCorrect) {
                wordResult.correctCount++;
                wordResult.consecutiveCorrect++;
                
                // æ£€æŸ¥æ˜¯å¦è¿ç»­3æ¬¡æ­£ç¡®
                if (wordResult.consecutiveCorrect >= 3) {
                    wordResult.isMastered = true;
                    currentStudySession.masteredWords.push(currentWord);
                    feedbackElement.innerHTML = `<span style="color: #4CAF50;">âœ… æ­£ç¡®ï¼</span><br><strong>ğŸ‰ æ­å–œï¼æ‚¨å·²å®Œå…¨æŒæ¡è¿™ä¸ªå•è¯ï¼</strong>`;
                } else {
                    feedbackElement.innerHTML = `<span style="color: #4CAF50;">âœ… æ­£ç¡®ï¼</span><br>è¿ç»­æ­£ç¡® ${wordResult.consecutiveCorrect}/3 æ¬¡`;
                }
            } else {
                wordResult.consecutiveCorrect = 0; // é‡ç½®è¿ç»­æ­£ç¡®è®¡æ•°
                feedbackElement.innerHTML = `<span style="color: #f44336;">âŒ é”™è¯¯</span><br>æ­£ç¡®ç­”æ¡ˆï¼š<strong>${correctAnswer}</strong>`;
            }
            
            // ç¦ç”¨æ‰€æœ‰é€‰é¡¹
            document.querySelectorAll('.test-option').forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === correctAnswer) {
                    btn.style.background = '#4CAF50';
                } else if (btn.textContent === selectedOption && !isCorrect) {
                    btn.style.background = '#f44336';
                }
            });
            
            // æ˜¾ç¤ºåé¦ˆ
            document.getElementById('test-feedback').classList.remove('hidden');
        }
        
        // ä¸‹ä¸€ä¸ªæµ‹è¯•é¢˜ç›®
        function nextTestQuestion() {
            currentStudySession.testCurrentIndex++;
            showTestQuestion();
        }
        
        // æ˜¾ç¤ºæŒæ¡åº¦æµ‹è¯•ç»“æœ
        function showMasteryTestResult() {
            document.getElementById('mastery-test').classList.add('hidden');
            document.getElementById('mastery-test-result').classList.remove('hidden');
            
            const masteredCount = currentStudySession.masteredWords.length;
            const totalTested = currentStudySession.knownWords.length;
            const needReviewCount = totalTested - masteredCount;
            
            // è®¡ç®—æ€»ä½“å‡†ç¡®ç‡
            let totalAttempts = 0;
            let totalCorrect = 0;
            
            Object.values(currentStudySession.testResults).forEach(result => {
                totalAttempts += result.attempts;
                totalCorrect += result.correctCount;
            });
            
            const accuracy = totalAttempts > 0 ? Math.round((totalCorrect / totalAttempts) * 100) : 0;
            
            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            document.getElementById('mastered-count').textContent = masteredCount;
            document.getElementById('need-review-count').textContent = needReviewCount;
            document.getElementById('test-accuracy').textContent = accuracy + '%';
            
            // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
            const detailsContainer = document.getElementById('mastery-details');
            let detailsHTML = '<h4>æµ‹è¯•è¯¦æƒ…ï¼š</h4>';
            
            if (masteredCount > 0) {
                detailsHTML += '<div style="color: #4CAF50; margin: 10px 0;"><strong>âœ… å®Œå…¨æŒæ¡çš„å•è¯ï¼š</strong><br>';
                detailsHTML += currentStudySession.masteredWords.map(word => word.word).join(', ');
                detailsHTML += '</div>';
            }
            
            if (needReviewCount > 0) {
                const needReviewWords = currentStudySession.knownWords.filter(word => 
                    !currentStudySession.testResults[word.word].isMastered
                );
                detailsHTML += '<div style="color: #FF9800; margin: 10px 0;"><strong>ğŸ“š éœ€è¦ç»§ç»­å¤ä¹ ï¼š</strong><br>';
                detailsHTML += needReviewWords.map(word => word.word).join(', ');
                detailsHTML += '</div>';
                
                // æ˜¾ç¤ºé‡æµ‹æŒ‰é’®
                document.getElementById('retest-btn').classList.remove('hidden');
            }
            
            detailsContainer.innerHTML = detailsHTML;
        }
        
        // é‡æµ‹è–„å¼±å•è¯
        function retestWeakWords() {
            const needRetestWords = currentStudySession.knownWords.filter(word => 
                !currentStudySession.testResults[word.word].isMastered
            );
            
            if (needRetestWords.length === 0) {
                alert('æ²¡æœ‰éœ€è¦é‡æµ‹çš„å•è¯ï¼');
                return;
            }
            
            // é‡ç½®è¿™äº›å•è¯çš„æµ‹è¯•è®°å½•
            needRetestWords.forEach(word => {
                currentStudySession.testResults[word.word] = {
                    attempts: 0,
                    correctCount: 0,
                    consecutiveCorrect: 0,
                    isMastered: false
                };
            });
            
            // é‡æ–°å¼€å§‹æµ‹è¯•
            currentStudySession.testWords = needRetestWords;
            currentStudySession.testCurrentIndex = 0;
            
            document.getElementById('mastery-test-result').classList.add('hidden');
            document.getElementById('mastery-test').classList.remove('hidden');
            
            showTestQuestion();
        }
        
        // å®ŒæˆæŒæ¡åº¦æµ‹è¯•
        function finishMasteryTest() {
            // å°†å®Œå…¨æŒæ¡çš„å•è¯æ ‡è®°ä¸ºå·²æŒæ¡
            currentStudySession.masteredWords.forEach(word => {
                const existingWord = learningData.learnedWords.find(w => w.word === word.word);
                if (existingWord) {
                    existingWord.masteryLevel = 'mastered';
                    existingWord.masteryTestDate = new Date().toISOString();
                } else {
                    addToLearned(word, 'mastered');
                }
            });
            
            // å°†æœªæŒæ¡çš„å•è¯åŠ å…¥å¤ä¹ è®¡åˆ’
            const needReviewWords = currentStudySession.knownWords.filter(word => 
                !currentStudySession.testResults[word.word].isMastered
            );
            
            needReviewWords.forEach(word => {
                addToReviewSchedule(word);
            });
            
            // æ›´æ–°ç»Ÿè®¡
            updateStats();
            updateStudyPlan();
            updateReviewSchedule();
            
            // è¿”å›å­¦ä¹ è®¡åˆ’é¡µé¢
            document.getElementById('mastery-test-result').classList.add('hidden');
            document.getElementById('study-plan-content').classList.remove('hidden');
            
            const masteredCount = currentStudySession.masteredWords.length;
            const totalCount = currentStudySession.knownWords.length;
            
            alert(`æŒæ¡åº¦æµ‹è¯•å®Œæˆï¼\nå®Œå…¨æŒæ¡ï¼š${masteredCount} ä¸ªå•è¯\néœ€è¦å¤ä¹ ï¼š${totalCount - masteredCount} ä¸ªå•è¯`);
        }
        
        // å®Œæˆå­¦ä¹ ä¼šè¯
        function finishStudySession() {
            // å°†ä¸è®¤è¯†çš„è¯åŠ å…¥å¤ä¹ è®¡åˆ’
            currentStudySession.unknownWords.forEach(word => {
                addToReviewSchedule(word);
            });
            
            // æ›´æ–°ç»Ÿè®¡
            updateStats();
            updateStudyPlan();
            updateReviewSchedule();
            
            // è¿”å›å­¦ä¹ è®¡åˆ’é¡µé¢
            document.getElementById('study-result').classList.add('hidden');
            document.getElementById('study-plan-content').classList.remove('hidden');
            
            alert(`å­¦ä¹ å®Œæˆï¼å·²æŒæ¡ ${currentStudySession.knownWords.length} ä¸ªæ–°å•è¯ã€‚`);
        }
        
        // å¤ä¹ ä¸è®¤è¯†çš„å•è¯
        function reviewUnknownWords() {
            if (currentStudySession.unknownWords.length === 0) {
                alert('æ²¡æœ‰éœ€è¦å¤ä¹ çš„å•è¯ï¼');
                return;
            }
            
            // é‡æ–°å¼€å§‹å­¦ä¹ ä¸è®¤è¯†çš„å•è¯
            currentStudySession.words = currentStudySession.unknownWords;
            currentStudySession.currentIndex = 0;
            currentStudySession.knownWords = [];
            currentStudySession.unknownWords = [];
            
            showStudySession();
        }
        
        // æ·»åŠ åˆ°å¤ä¹ è®¡åˆ’
        function addToReviewSchedule(wordData) {
            const reviewWord = {
                word: wordData.word,
                translation: wordData.translations[0].translation,
                level: currentStudySession.level,
                addDate: new Date().toISOString(),
                reviewCount: 0,
                nextReview: getNextReviewDate(0),
                difficulty: 'hard', // ä¸è®¤è¯†çš„è¯æ ‡è®°ä¸ºå›°éš¾
                masteryLevel: 'learned'
            };
            
            // é¿å…é‡å¤æ·»åŠ 
            const existing = learningData.learnedWords.find(w => w.word === wordData.word);
            if (!existing) {
                learningData.learnedWords.push(reviewWord);
            }
            
            saveLearningData();
        }
        
        // æ›´æ–°å¤ä¹ è®¡åˆ’
        function updateReviewSchedule() {
            const today = new Date();
            const reviewSchedule = document.getElementById('review-schedule');
            
            // è·å–éœ€è¦å¤ä¹ çš„å•è¯
            const wordsToReview = learningData.learnedWords.filter(word => {
                const reviewDate = new Date(word.nextReview);
                return reviewDate <= today;
            });
            
            const upcomingReviews = learningData.learnedWords.filter(word => {
                const reviewDate = new Date(word.nextReview);
                return reviewDate > today && reviewDate <= new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            });
            
            reviewSchedule.innerHTML = `
                <div class="review-item due">
                    <h3>ğŸ”¥ éœ€è¦å¤ä¹ </h3>
                    <div class="stat-number">${wordsToReview.length}</div>
                    <p>ä¸ªå•è¯</p>
                </div>
                <div class="review-item">
                    <h3>ğŸ“… æœ¬å‘¨è®¡åˆ’</h3>
                    <div class="stat-number">${upcomingReviews.length}</div>
                    <p>ä¸ªå•è¯</p>
                </div>
                <div class="review-item">
                    <h3>âœ… å·²æŒæ¡</h3>
                    <div class="stat-number">${learningData.learnedWords.filter(w => w.reviewCount >= 5).length}</div>
                    <p>ä¸ªå•è¯</p>
                </div>
                <div class="review-item">
                    <h3>ğŸ“š æ€»å­¦ä¹ </h3>
                    <div class="stat-number">${learningData.learnedWords.length}</div>
                    <p>ä¸ªå•è¯</p>
                </div>
            `;
        }
        
        // å¼€å§‹å¤ä¹ 
        function startReview() {
            const today = new Date();
            const wordsToReview = learningData.learnedWords.filter(word => {
                const reviewDate = new Date(word.nextReview);
                return reviewDate <= today;
            });
            
            if (wordsToReview.length === 0) {
                alert('æš‚æ— éœ€è¦å¤ä¹ çš„å•è¯ï¼');
                return;
            }
            
            // è¿™é‡Œå¯ä»¥å®ç°å¤ä¹ ç•Œé¢
            alert(`å¼€å§‹å¤ä¹  ${wordsToReview.length} ä¸ªå•è¯ï¼\n\n${wordsToReview.slice(0, 3).map(w => w.word).join(', ')}...`);
            
            // æ¨¡æ‹Ÿå¤ä¹ å®Œæˆ
            wordsToReview.forEach(word => {
                word.reviewCount++;
                word.nextReview = getNextReviewDate(word.reviewCount);
                learningData.stats.totalReviewed++;
            });
            
            saveLearningData();
            updateReviewSchedule();
            updateStats();
        }
        
        // æ¸…é™¤å¤ä¹ æ•°æ®
        function clearReviewData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å­¦ä¹ æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                learningData = {
                    userLevel: 0,
                    studyPlan: [],
                    reviewSchedule: [],
                    learnedWords: [],
                    stats: {
                        totalLearned: 0,
                        totalReviewed: 0,
                        studyDays: 0,
                        currentStreak: 0,
                        lastStudyDate: null
                    }
                };
                saveLearningData();
                updateStats();
                updateReviewSchedule();
                updateStudyPlan();
                alert('å­¦ä¹ æ•°æ®å·²æ¸…é™¤ï¼');
            }
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('total-learned').textContent = learningData.stats.totalLearned;
            document.getElementById('total-reviewed').textContent = learningData.stats.totalReviewed;
            document.getElementById('study-days').textContent = learningData.stats.studyDays;
            document.getElementById('current-streak').textContent = learningData.stats.currentStreak;
            
            // æ›´æ–°å­¦ä¹ è¿›åº¦å›¾è¡¨
            updateProgressCharts();
        }
        
        // æ›´æ–°è¿›åº¦å›¾è¡¨
        function updateProgressCharts() {
            const chartsContainer = document.getElementById('progress-charts');
            
            // æŒ‰çº§åˆ«ç»Ÿè®¡å­¦ä¹ è¿›åº¦
            const levelProgress = {};
            for (let level = 1; level <= 6; level++) {
                const levelWords = vocabularyData[level] || [];
                const learnedInLevel = learningData.learnedWords.filter(w => w.level === level).length;
                levelProgress[level] = {
                    name: levels[level].name,
                    total: levelWords.length,
                    learned: learnedInLevel,
                    percentage: levelWords.length > 0 ? Math.round((learnedInLevel / levelWords.length) * 100) : 0
                };
            }
            
            chartsContainer.innerHTML = Object.values(levelProgress).map(level => `
                <div class="plan-item">
                    <div>
                        <strong>${level.name}</strong><br>
                        <span>${level.learned} / ${level.total} è¯</span>
                    </div>
                    <div class="stat-number">${level.percentage}%</div>
                </div>
            `).join('');
        }
        
        // ä¿å­˜å­¦ä¹ æ•°æ®
        function saveLearningData() {
            localStorage.setItem('vocabularyLearningData', JSON.stringify(learningData));
        }
        
        // åŠ è½½å­¦ä¹ æ•°æ®
        function loadLearningData() {
            const saved = localStorage.getItem('vocabularyLearningData');
            if (saved) {
                learningData = JSON.parse(saved);
                updateStudyPlan();
            }
        }
    </script>
</body>
</html>